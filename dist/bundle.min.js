(()=>{"use strict";(()=>{class e{"use strict";constructor(e,t,n=!1){this.x=e,this.y=t,this.isOccupied=n}isOccupied;set isOccupied(e){this.isOccupied=e}get isOccupied(){return this.isOccupied}}class t{PIECE=[new e(4,0,!0),new e(4,1,!0),new e(4,2,!0),new e(5,2,!0)]}class n{PIECE=[new e(4,0,!0),new e(4,1,!0),new e(4,2,!0),new e(3,2,!0)]}class r{PIECE=[new e(4,0,!0),new e(4,1,!0),new e(5,1,!0),new e(5,2,!0)]}class o{PIECE=[new e(5,0,!0),new e(5,1,!0),new e(4,1,!0),new e(4,2,!0)]}class i{PIECE=[new e(4,0,!0),new e(4,1,!0),new e(4,2,!0),new e(4,3,!0)]}class c{PIECE=[new e(3,0,!0),new e(4,0,!0),new e(5,0,!0),new e(4,1,!0)]}class a{PIECE=[new e(4,0,!0),new e(5,0,!0),new e(4,1,!0),new e(5,1,!0)]}const l=2,s="white",u=35,d="white",f="black",h=24,g=10,w="KeyP",y="Highscore not found",p=function(){const l=()=>function(){const e=Math.floor(7*Math.random());return 0===e?new t:1===e?new a:2===e?new c:3===e?new n:4===e?new r:5===e?new o:new i}(),s=(e,t)=>{t.every((function(t){return e[t.y][t.x].isOccupied=!0}))};function u(e,t){if(function(e){return e[0].x==e[2].x&&e[1].x==e[3].x&&e[0].y==e[1].y}(t))return t;let n;try{if(n=function(e){const t={x:e[1].x,y:e[1].y};let n=[{x:0,y:0},{x:t.x,y:t.y},{x:0,y:0},{x:0,y:0}];for(let r=0;r<e.length;r++){if(1===r)continue;let o=e[r].x-t.x,i=e[r].y-t.y,c=-1===Math.sign(o),a=-1===Math.sign(i);0===o?(n[r].x=a?t.x+Math.abs(i):t.x-Math.abs(i),n[r].y=t.y):0===i?(n[r].x=t.x,n[r].y=c?t.y-Math.abs(o):t.y+Math.abs(o)):c&&a?(n[r].x=t.x+Math.abs(i),n[r].y=t.y-Math.abs(o)):c||a?c&&!a?(n[r].x=t.x-Math.abs(i),n[r].y=t.y-Math.abs(o)):!c&&a&&(n[r].x=t.x+Math.abs(i),n[r].y=t.y+Math.abs(o)):(n[r].x=t.x-Math.abs(i),n[r].y=t.y+Math.abs(o))}return n}(t),function(e,t){return t.some((t=>t.x<0||t.y<e[0].y||t.x>e[0].length-1||t.y>e.length-1||e[t.y][t.x].isOccupied))}(e,n))return console.log("can't rotate piece"),t;for(let e=0;e<n.length;e++)1!==e&&(t[e].x=n[e].x,t[e].y=n[e].y)}catch{console.log("can't rotate piece")}return t}function d(t){const n=Array.from({length:10},((t,n)=>new e(n,0)));return t.unshift(n)}function f(e){return 1500/(1.8*e)}return{calculateFps:f,createBoard:function(){return Array.from({length:h},((t,n)=>Array.from({length:g},((t,n)=>new e(n,0)))))},createTestBoard:function(){return Array.from({length:h},((t,n)=>n<20?Array.from({length:g},((t,n)=>new e(n,0))):Array.from({length:g},((t,n)=>n<9?new e(n,0,!0):new e(n,0)))))},newPiece:l,newTestPiece:()=>(new i).PIECE,checkFullRowsAndEndCondition:function(e){let t=[];for(let n=e.length-1;n>=0;n--){let r=!0;for(let t=0;t<e[n].length;t++)if(e[n][t].isOccupied||(r=!1),0===n&&e[n][t].isOccupied)return-1;r&&t.push(n)}return function(e,t){if(t.length){let n=t.length-1;for(;n>=0;)e.splice(t[n],1),d(e),n--}}(e,t),t.length},incrementLevelAfter10Clears:function(e,t){return e>=10&&(e-=10,t++),{trackRowCount:e,level:t}},moveToNextLevel:function(e){return console.log(`Moving to level ${e}`),f(e)},movePiece:function(e,t,n="down"){if(t.length){if("left"===n){if(t.every((e=>e.x>0)))for(let e=0;e<t.length;e++)t[e].x--;if(t.some((t=>e[t.y][t.x].isOccupied))){console.log("cant move there");for(let e=0;e<t.length;e++)t[e].x++}}if("right"===n){if(t.every((t=>t.x<e[0].length-1)))for(let e=0;e<t.length;e++)t[e].x++;if(t.some((t=>e[t.y][t.x].isOccupied))){console.log("cant move there");for(let e=0;e<t.length;e++)t[e].x--}}return"up"==n&&(t=u(e,t)),"down"===n&&(t=function(e,t){if(!t.every((t=>t.y<e.length-1)))return s(e,t),-1;for(let e=0;e<t.length;e++)t[e].y++;if(t.some((t=>e[t.y][t.x].isOccupied))){for(let e=0;e<t.length;e++)t[e].y--;return s(e,t),-1}return t}(e,t)),t}},rotatePiece:u,addScore:function(e,t,n){return n+(1===e?40*t:2===e?100*t:3===e?300*t:4===e?1200*t:0)},PieceStack:function(){let e=Array.from({length:5},(e=>l()));this.getStack=function(){return e},this.getPiece=function(){let t=document.querySelector(".piece-stack__piece:first-of-type");if(t){let e=t.cloneNode(!0);e.className="piece-stack__effect-piece",document.querySelector(".tetris-container").appendChild(e),setTimeout((()=>{e.remove()}),140)}return e.push(l()),e.shift()}}}}();const m="tetris.highscores";class v extends Error{}const x={name:"",score:0};function E(e){let t;if(e);else try{t=function(){let e,t;for(let n=0;t=window.localStorage.key(n);n++)t==m&&(e=JSON.parse(window.localStorage.getItem(t)));if(e)return e;throw new v(y)}()}catch(e){console.log(e),t=Array.from({length:10},(()=>({...x})))}return t}function S(e,t){for(;e.firstChild;)e.firstChild.remove();let n=document.createElement("div");n.className="highscores";for(let e of t)n.appendChild(C(e.name,e.score));e.appendChild(n)}function C(e,t){let n=document.createElement("div");n.className="highscores__score";let r=document.createElement("span");r.innerText=e;let o=document.createElement("span");return o.innerText=t||"",n.appendChild(r),n.appendChild(o),n}async function L(e,t,n){let r=t.findIndex((e=>e.score<n));return-1!=r?(console.log("New highscore"),function(e,t,n,r){const o=[...t.slice(0,r),{name:n.name,score:n.score},...t.slice(r,-1)];var i;return S(e,o),i=o,window.localStorage.setItem("tetris.highscores",JSON.stringify(i)),o}(e,t,{name:await b(),score:n},r)):t}async function b(){return new Promise(((e,t)=>{const n=document.createElement("form");n.id="highscoreForm",n.className="js-name-form";const r=function(e=[]){const t=document.createElement("input");for(let n of e)t.setAttribute(n.name,n.value);return t}([{name:"type",value:"text"},{name:"name",value:"name"},{name:"maxLength",value:"8"},{name:"placeholder",value:"Enter name (max 8 letter A-B)"}]);n.appendChild(r);const o=document.createElement("input");o.setAttribute("type","submit"),o.setAttribute("value","Submit"),n.appendChild(o),document.querySelector(".page-container").appendChild(n),n.addEventListener("submit",(t=>{t.preventDefault();let n=t.target.name.value;var r;!((r=n).length>8||!/^[a-zA-z]+$/gi.test(r))||(t.target.remove(),b()),t.target.remove(),e(n)}))}))}const k=function(e){return function(){const t=e?.querySelector("#myCanvas"),n=u,r=l,o=n*h,i=n*g,c=t.getContext("2d");t.height=o,t.width=i;const a=e.getElementById("score"),w=e.getElementById("finalScore"),y=e.getElementById("lvl"),p=e.getElementById("gOvr"),m=e.getElementById("gamePaused");let v,x=s,E=f,S=d,C=f;const L=e.querySelector(".state-info__piece-stack");function b(e,t){c.beginPath(),c.lineWidth=.2,c.strokeStyle=C;let o,i,a=""+t/h;v?(o=255-255*a+3*t,i=t>0?o-5*t:o):(o=255*a,i=t>0?o-5*t:o);let l=c.createLinearGradient(r+n*e,r+n*t,n*e+n,n*t+n),s=`rgb(${o}, ${o}, ${o})`,u=`rgb(${i}, ${i}, ${i})`,d=a<.3?.3:a>.8?.8:a;l.addColorStop(.2,s),l.addColorStop(d,u),c.fillStyle=l,c.fillRect(n*e,n*t,n,n),c.strokeStyle=E,c.strokeRect(.2+n*e,.2+n*t,n-.4,n-.4)}function k(e){for(let t=e.length-1;t>0;t--)for(let n=0;n<e[t].length;n++)e[t][n].isOccupied&&b(n,t)}function P(e,n){c.clearRect(0,0,t.width,t.height),k(e),function(e){for(let t=e.length-1;t>=0;t--)e[t].isOccupied&&b(e[t].x,e[t].y)}(n)}function A(t){const n=e.querySelector(".state-info__level");for(n.style.display="block";n.firstChild;)n.firstChild.remove();let r=e.createElement("h1");r.innerText=0===t?"":`Level ${t}`,r.id="lvl",n.appendChild(r)}return{resetUi:function(e){A(e),playButton.innerText="Play",a.innerText=0,p.setAttribute("style","opacity: 0%"),m.innerText="",w.innerText="",y.setAttribute("style","letter-spacing: 0px background: none opacity: 100")},clearBoard:function(){c.clearRect(0+r,0+r,t.width-2*r,t.height-2*r)},drawBoard:k,drawEverything:P,displayGameOver:function(){p.style.opacity=1},displayFinalScore:function(e){w.innerText="Your score: \n"+e},updateScore:function(e){a.innerText=e},pause:function(){const t=e.querySelector(".state-info__piece-stack > *:first-child");m.innerText="PAUSED",t.style.animation="none"},unPause:function(){const t=e.querySelector(".state-info__piece-stack > *:first-child");m.innerText="",t.style.animation="var(--animation-first-piece)"},displayLevelText:A,polarizeHandler:function(e,t,n){if(console.log("handling polarization"),e.classList.contains("polarized")?(x=s,E=d,S=d,C=f,v=!1):(x=f,E=f,S=f,C=d,v=!0),e.classList.toggle("polarized"),null==t)return P([],[]);P(t,n)},displayPieceStack:function(t){for(L.style.opacity="1";L.firstChild;)L.firstChild.remove();for(let n=0;n<t.length;n++){let r=L.appendChild(e.createElement("div"));r.classList=`${t[n].constructor.name} piece-stack__piece`;for(let o of t[n].PIECE){let t=e.createElement("div"),i=20-2*n;t.className="piece-stack__square",t.style.cssText=`left: ${(o.x-4)*i}%; top: ${o.y*i}%; width: ${i}%; height: ${i}%; opacity: ${100-20*n}%;`,r.appendChild(t)}}},removePieceStack:function(){for(;L.firstChild;)L.firstChild.remove()}}}()}(document);!function(e){(()=>{let t,n,r,o,i,c,a,l,s;var u;let d;k.resetUi(0);let f=!0;const h=e.querySelector(".highscore-wrapper"),g=e.querySelector(".highscore-wrapper");let y={checkForHighscore:L,getHighscores:E,renderScores:S},m=y.getHighscores();function v(e){a||l?(window.clearTimeout(u),u=null):(x(e),({trackRowCount:c,level:o}=p.incrementLevelAfter10Clears(c,o)),s!=o&&(s=o,i=p.moveToNextLevel(o),k.displayLevelText(o)),u=C())}async function x(e){n=p.movePiece(t,n,e),-1==n&&(n=d.getPiece().PIECE,k.displayPieceStack(d.getStack()));let i=p.checkFullRowsAndEndCondition(t);if(-1===i)return console.log("Game over"),l=!0,h.classList.add("game-over"),k.displayGameOver(),k.displayFinalScore(r),k.removePieceStack(),A.innerText="Play",void(m=await y.checkForHighscore(g,m,r));c+=i,r=p.addScore(i,o,r),k.drawEverything(t,n),k.updateScore(r)}function C(){return window.setTimeout(v,i)}function b(){return a?(u=C(),k.unPause()):(window.clearTimeout(u),k.pause(),u=null),a=!a}y.renderScores(g,m);const P=["ArrowUp","ArrowRight","ArrowDown","ArrowLeft"];e.addEventListener("keydown",(e=>{if(!l&&!f)if(P.includes(e.code)){if(a)return;x(e.code.slice(5).toLowerCase())}else e.code!=w||b()}));const A=e.getElementById("playButton");A.onclick=()=>{console.log("initializing"),null!=u&&(window.clearTimeout(u),u=null),f&&(e.querySelector(".scoreboard").style.transform="translateY(0)",f=!1),d=new p.PieceStack,t=p.createBoard(),n=d.getPiece().PIECE,r=0,o=1,i=p.calculateFps(o),c=0,a=!1,l=!1,s=o,[...h.classList].includes("game-over")&&h.classList.remove("game-over"),k.displayPieceStack(d.getStack()),k.resetUi(o),k.drawEverything(t,n),console.log("Game started"),u=C(),A.innerText="Restart"},e.querySelector("#pauseButton").onclick=b,e.querySelector("#themeSwitch").onclick=()=>k.polarizeHandler(e.body,t,n,d?.getStack()),function(e,t){console.log("Injecting mobile controls");let n=e.createElement("div");n.className="mobile-controls-wrapper",n.innerHTML='\n    <div class="mobile-controls">\n      <div class="js-rotate">\n        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="sync" class="svg-inline--fa fa-sync fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M440.65 12.57l4 82.77A247.16 247.16 0 0 0 255.83 8C134.73 8 33.91 94.92 12.29 209.82A12 12 0 0 0 24.09 224h49.05a12 12 0 0 0 11.67-9.26 175.91 175.91 0 0 1 317-56.94l-101.46-4.86a12 12 0 0 0-12.57 12v47.41a12 12 0 0 0 12 12H500a12 12 0 0 0 12-12V12a12 12 0 0 0-12-12h-47.37a12 12 0 0 0-11.98 12.57zM255.83 432a175.61 175.61 0 0 1-146-77.8l101.8 4.87a12 12 0 0 0 12.57-12v-47.4a12 12 0 0 0-12-12H12a12 12 0 0 0-12 12V500a12 12 0 0 0 12 12h47.35a12 12 0 0 0 12-12.6l-4.15-82.57A247.17 247.17 0 0 0 255.83 504c121.11 0 221.93-86.92 243.55-201.82a12 12 0 0 0-11.8-14.18h-49.05a12 12 0 0 0-11.67 9.26A175.86 175.86 0 0 1 255.83 432z"></path></svg>\n      </div>\n      <div class="js-arrow-right">\n        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-right" class="svg-inline--fa fa-arrow-right fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>\n      </div>\n      <div class="js-arrow-down">\n        <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-down" class="svg-inline--fa fa-arrow-down fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M413.1 222.5l22.2 22.2c9.4 9.4 9.4 24.6 0 33.9L241 473c-9.4 9.4-24.6 9.4-33.9 0L12.7 278.6c-9.4-9.4-9.4-24.6 0-33.9l22.2-22.2c9.5-9.5 25-9.3 34.3.4L184 343.4V56c0-13.3 10.7-24 24-24h32c13.3 0 24 10.7 24 24v287.4l114.8-120.5c9.3-9.8 24.8-10 34.3-.4z"></path></svg>\n      </div>\n      <div class="js-arrow-left">\n      <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-left" class="svg-inline--fa fa-arrow-left fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M257.5 445.1l-22.2 22.2c-9.4 9.4-24.6 9.4-33.9 0L7 273c-9.4-9.4-9.4-24.6 0-33.9L201.4 44.7c9.4-9.4 24.6-9.4 33.9 0l22.2 22.2c9.5 9.5 9.3 25-.4 34.3L136.6 216H424c13.3 0 24 10.7 24 24v32c0 13.3-10.7 24-24 24H136.6l120.5 114.8c9.8 9.3 10 24.8.4 34.3z"></path></svg>\n      </div>\n    </div>\n  ',e.body.appendChild(n);const r=e.querySelector(".js-rotate"),o=e.querySelector(".js-arrow-right"),i=e.querySelector(".js-arrow-down"),c=e.querySelector(".js-arrow-left");var a;function l(e,n=100){t(e),a=setTimeout((()=>{!function(e,t){l(e,t)}(e,n)}),n)}function s(){a&&clearTimeout(a)}r.addEventListener("touchstart",(()=>l("up",400))),o.addEventListener("touchstart",(()=>l("right",200))),i.addEventListener("touchstart",(()=>l("down",100))),c.addEventListener("touchstart",(()=>l("left",400))),r.addEventListener("touchend",s),o.addEventListener("touchend",s),i.addEventListener("touchend",s),c.addEventListener("touchend",s)}(e,x);const T=e.querySelector(".tetris-container"),M=e.querySelector("#myCanvas");window.onload=()=>{T.style.width=`${M.clientWidth+6}px`},window.onresize=()=>{T.style.width=`${M.clientWidth+6}px`}})()}(document)})()})();